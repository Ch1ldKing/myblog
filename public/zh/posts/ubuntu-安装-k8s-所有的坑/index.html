<!DOCTYPE html>
<html lang="zh" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="noindex, nofollow">
<title>Ubuntu 安装 K8s 所有的坑 | Dorianyang 的妙妙文档</title>
<meta name="keywords" content="problem, ubuntu, kubernetes, cicd, nacos">
<meta name="description" content="在ubuntu 安装时，手动配置 ipv4，name servers 和 searchdomains 是什么

Name Servers（DNS 服务器）
用于解析域名。例如：
•	8.8.8.8, 8.8.4.4（Google DNS）
•	或者你网络提供商的 DNS，如 114.114.114.114

填写多个时用 逗号分隔。

Search Domains（搜索域）
这个选项是为了方便局域网域名解析。举个例子：
•	如果你填写了 example.com，当你在终端中访问 server1，系统会自动尝试解析为 server1.example.com。
•	多个域名可以用空格分隔：example.com local.lan

这主要用于企业或学校内的内网环境，不填也可以。
我使用虚拟机和 NAT 网络，如何配置代理？我的宿主机上使用 Clash
确认 Clash 开放了公网访问（监听 0.0.0.0）
编辑 Clash 的配置文件 ~/.config/clash/config.yaml 或 clash.meta.yaml，确保监听地址改为：
mixed-port: 7890
allow-lan: true   # ✅ 允许局域网设备访问 Clash
bind-address: 0.0.0.0  # ✅ 不要写 127.0.0.1
在虚拟机中设置代理
在 Ubuntu 虚拟机里，可以这样设置环境变量方式配置代理：
export http_proxy=&#34;http://192.168.79.1:7890&#34;
export https_proxy=&#34;http://192.168.79.1:7890&#34;
export all_proxy=&#34;socks5://192.168.79.1:7891&#34;
K8s 安装软件仓库地址
关于 https://github.com/kubernetes/kubernetes/issues/123673 ，
Kubernetes 更改了其软件包仓库（repository）的地址。旧的仓库地址（通常是 apt.kubernetes.io）已弃用，并迁移到了新的地址 pkgs.k8s.io">
<meta name="author" content="Dorianyang">
<link rel="canonical" href="http://localhost:1313/zh/posts/ubuntu-%E5%AE%89%E8%A3%85-k8s-%E6%89%80%E6%9C%89%E7%9A%84%E5%9D%91/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.870ec7a738304234433d49dc79f1ec1321b5a5537afaca6d257283b72972b738.css" integrity="sha256-hw7HpzgwQjRDPUncefHsEyG1pVN6&#43;sptJXKDtylytzg=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/static/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/static/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/static/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/static/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="zh" href="http://localhost:1313/zh/posts/ubuntu-%E5%AE%89%E8%A3%85-k8s-%E6%89%80%E6%9C%89%E7%9A%84%E5%9D%91/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript>

    
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-CR1332THT7"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-CR1332THT7');
    </script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/zh/" accesskey="h" title="Ch1ldKing (Alt + H)">
                <img src="http://localhost:1313/static/apple-touch-icon.png" alt="" aria-label="logo"
                    height="35">Ch1ldKing</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                    <ul class="lang-switch"><li>|</li>
                        <li>
                            <a href="http://localhost:1313/en/" title="English"
                                aria-label="English">En</a>
                        </li>
                    </ul>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/zh/search/" title="搜索 (Alt &#43; /)" accesskey=/>
                    <span>搜索</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/about/" title="关于">
                    <span>关于</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/resume/" title="简历">
                    <span>简历</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/tags/" title="分类">
                    <span>分类</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/zh/archives/" title="时间线">
                    <span>时间线</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/zh/">主页</a>&nbsp;»&nbsp;<a href="http://localhost:1313/zh/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Ubuntu 安装 K8s 所有的坑
    </h1>
    <div class="post-meta"><span title='2025-10-15 04:10:14 +0800 CST'>2025年10月15日</span>&nbsp;·&nbsp;<span>6 分钟</span>&nbsp;·&nbsp;<span>1172 字</span>&nbsp;·&nbsp;<span>Dorianyang</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">目录</span>
        </summary>

        <div class="inner"><nav id="TableOfContents">
  <ul>
    <li>
      <ul>
        <li><a href="#在ubuntu-安装时手动配置-ipv4name-servers-和-searchdomains-是什么">在ubuntu 安装时，手动配置 ipv4，name servers 和 searchdomains 是什么</a></li>
        <li><a href="#我使用虚拟机和-nat-网络如何配置代理我的宿主机上使用-clash">我使用虚拟机和 NAT 网络，如何配置代理？我的宿主机上使用 Clash</a></li>
        <li><a href="#k8s-安装软件仓库地址">K8s 安装软件仓库地址</a></li>
        <li><a href="#k8s初始化">K8s初始化</a></li>
        <li><a href="#删除pods">删除pods</a></li>
        <li><a href="#安装网络组件">安装网络组件</a></li>
        <li><a href="#安装mysql-pod">安装MySQL Pod</a></li>
        <li><a href="#安装nacos">安装Nacos</a></li>
        <li><a href="#彻底恢复-pv">彻底恢复 PV</a></li>
        <li><a href="#nodeport-与-clusterip">NodePort 与 ClusterIP</a></li>
        <li><a href="#nacos-pod-has-unbound-immediate-persistentvolumeclaims">Nacos pod has unbound immediate PersistentVolumeClaims</a></li>
        <li><a href="#安装nacos镜像无法访问">安装nacos镜像无法访问</a></li>
        <li><a href="#安装ingress-controller">安装ingress-controller</a></li>
        <li><a href="#ingress的nodeport访问不到">Ingress的NodePort访问不到</a></li>
        <li><a href="#helm-安装jenkins">Helm 安装Jenkins</a></li>
        <li><a href="#error-unknown-command-portforward-for-kubectl">error: unknown command &ldquo;port‑forward&rdquo; for &ldquo;kubectl&rdquo;</a></li>
        <li><a href="#jenkins登录后报错">Jenkins登录后报错</a></li>
        <li><a href="#jenkins-k8s中无法配置-maven-和-jdk">Jenkins K8S中无法配置 maven 和 jdk</a></li>
        <li><a href="#ubuntu虚拟机创建-20g-但只有-10g">Ubuntu虚拟机创建 20G 但只有 10G</a></li>
        <li><a href="#jenkins构建后节点磁盘空间问题">Jenkins构建后节点磁盘空间问题</a></li>
        <li><a href="#dockerhub-限速问题">DockerHub 限速问题</a></li>
        <li><a href="#springboot-bootstrap问题">Springboot bootstrap问题</a></li>
        <li><a href="#dashboard-token">dashboard token</a></li>
        <li><a href="#k8s驱逐问题">k8s驱逐问题</a></li>
        <li><a href="#sentinel识别不到服务">Sentinel识别不到服务</a></li>
        <li><a href="#helm部署rabbitmq">helm部署RabbitMQ</a></li>
      </ul>
    </li>
  </ul>
</nav>
        </div>
    </details>
</div>

  <div class="post-content"><h3 id="在ubuntu-安装时手动配置-ipv4name-servers-和-searchdomains-是什么">在ubuntu 安装时，手动配置 ipv4，name servers 和 searchdomains 是什么<a hidden class="anchor" aria-hidden="true" href="#在ubuntu-安装时手动配置-ipv4name-servers-和-searchdomains-是什么">#</a></h3>
<ol start="4">
<li>Name Servers（DNS 服务器）
用于解析域名。例如：
•	8.8.8.8, 8.8.4.4（Google DNS）
•	或者你网络提供商的 DNS，如 114.114.114.114</li>
</ol>
<p>填写多个时用 逗号分隔。</p>
<ol start="5">
<li>Search Domains（搜索域）
这个选项是为了方便局域网域名解析。举个例子：
•	如果你填写了 example.com，当你在终端中访问 server1，系统会自动尝试解析为 server1.example.com。
•	多个域名可以用空格分隔：example.com local.lan</li>
</ol>
<p>这主要用于企业或学校内的内网环境，不填也可以。</p>
<h3 id="我使用虚拟机和-nat-网络如何配置代理我的宿主机上使用-clash">我使用虚拟机和 NAT 网络，如何配置代理？我的宿主机上使用 Clash<a hidden class="anchor" aria-hidden="true" href="#我使用虚拟机和-nat-网络如何配置代理我的宿主机上使用-clash">#</a></h3>
<p>确认 Clash 开放了公网访问（监听 0.0.0.0）</p>
<p>编辑 Clash 的配置文件 ~/.config/clash/config.yaml 或 clash.meta.yaml，确保监听地址改为：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">mixed-port</span>: <span style="color:#ae81ff">7890</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">allow-lan</span>: <span style="color:#66d9ef">true</span>   <span style="color:#75715e"># ✅ 允许局域网设备访问 Clash</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">bind-address</span>: <span style="color:#ae81ff">0.0.0.0</span>  <span style="color:#75715e"># ✅ 不要写 127.0.0.1</span>
</span></span></code></pre></div><p>在虚拟机中设置代理
在 Ubuntu 虚拟机里，可以这样设置环境变量方式配置代理：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>export http_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://192.168.79.1:7890&#34;</span>
</span></span><span style="display:flex;"><span>export https_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://192.168.79.1:7890&#34;</span>
</span></span><span style="display:flex;"><span>export all_proxy<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;socks5://192.168.79.1:7891&#34;</span>
</span></span></code></pre></div><h3 id="k8s-安装软件仓库地址">K8s 安装软件仓库地址<a hidden class="anchor" aria-hidden="true" href="#k8s-安装软件仓库地址">#</a></h3>
<p>关于 <a href="https://github.com/kubernetes/kubernetes/issues/123673">https://github.com/kubernetes/kubernetes/issues/123673</a> ，
Kubernetes 更改了其软件包仓库（repository）的地址。旧的仓库地址（通常是 apt.kubernetes.io）已弃用，并迁移到了新的地址 pkgs.k8s.io</p>
<p>首先我们要删除原来的/etc/apt/sources.list.d/kubernetes.list或者是中央sources.list中的k8s相关
然后</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>echo <span style="color:#e6db74">&#34;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /&#34;</span> | sudo tee /etc/apt/sources.list.d/kubernetes.list
</span></span></code></pre></div><pre tabindex="0"><code>$ curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg
</code></pre><p>/etc/apt/keyrings/这个文件夹可能需要自己创建
然后</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>sudo apt install -y kubelet kubeadm kubectl
</span></span></code></pre></div><h3 id="k8s初始化">K8s初始化<a hidden class="anchor" aria-hidden="true" href="#k8s初始化">#</a></h3>
<p>The connection to the server localhost:8080 was refused - did you specify the right host or port?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir -p $HOME/.kube
</span></span><span style="display:flex;"><span>sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
</span></span><span style="display:flex;"><span>sudo chown <span style="color:#66d9ef">$(</span>id -u<span style="color:#66d9ef">)</span>:<span style="color:#66d9ef">$(</span>id -g<span style="color:#66d9ef">)</span> $HOME/.kube/config
</span></span></code></pre></div><p>`kubectl get nodes</p>
<h3 id="删除pods">删除pods<a hidden class="anchor" aria-hidden="true" href="#删除pods">#</a></h3>
<p>只需要删除对应的配置文件即可，比如</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-zsh" data-lang="zsh"><span style="display:flex;"><span>kubectl delete -f kube-flannel.yml
</span></span></code></pre></div><h3 id="安装网络组件">安装网络组件<a hidden class="anchor" aria-hidden="true" href="#安装网络组件">#</a></h3>
<p>在安装前，需要运行</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubeadm init --pod-network-cidr<span style="color:#f92672">=</span>10.244.0.0/16
</span></span></code></pre></div><h3 id="安装mysql-pod">安装MySQL Pod<a hidden class="anchor" aria-hidden="true" href="#安装mysql-pod">#</a></h3>
<p>注意一定要有PV和PVC，否则PVC无法正确创建。不是所有的环境都能够自动配置StorageLCass</p>
<h3 id="安装nacos">安装Nacos<a hidden class="anchor" aria-hidden="true" href="#安装nacos">#</a></h3>
<p><a href="https://github.com/nacos-group/nacos-k8s/blob/master/README-CN.md">https://github.com/nacos-group/nacos-k8s/blob/master/README-CN.md</a></p>
<h3 id="彻底恢复-pv">彻底恢复 PV<a hidden class="anchor" aria-hidden="true" href="#彻底恢复-pv">#</a></h3>
<pre tabindex="0"><code>kubectl get pv mysql-data-pv
</code></pre><p>删除整个claimRef块</p>
<h3 id="nodeport-与-clusterip">NodePort 与 ClusterIP<a hidden class="anchor" aria-hidden="true" href="#nodeport-与-clusterip">#</a></h3>
<p>准确来说设置 NodePort 没什么影响，只是会扩大暴露范围，并且它是有范围的</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Service</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">labels</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort                  </span> <span style="color:#75715e"># &lt;— makes it reachable on the node’s IP</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">selector</span>:
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">name</span>: <span style="color:#ae81ff">mysql</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">port</span>:     <span style="color:#ae81ff">33066</span>              <span style="color:#75715e"># &lt;— the “internal” ClusterIP port (clients in-cluster)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">targetPort</span>: <span style="color:#ae81ff">3306</span>             <span style="color:#75715e"># &lt;— the container’s actual listening port</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>:   <span style="color:#ae81ff">33066</span>            <span style="color:#75715e"># &lt;— the port on each node’s IP</span>
</span></span></code></pre></div><p>范围可调</p>
<h3 id="nacos-pod-has-unbound-immediate-persistentvolumeclaims">Nacos pod has unbound immediate PersistentVolumeClaims<a hidden class="anchor" aria-hidden="true" href="#nacos-pod-has-unbound-immediate-persistentvolumeclaims">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl get pvc data-nacos-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME           STATUS    VOLUME   CAPACITY   ACCESS MODES   STORAGECLASS          AGE
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data-nacos-0   Pending                                      managed-nfs-storage   3d19h
</span></span></code></pre></div><p>查看它的情况</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl describe pvc data-nacos-0
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...Waiting <span style="color:#66d9ef">for</span> a volume to be created either by the external provisioner <span style="color:#e6db74">&#39;fuseim.pri/ifs&#39;</span> or manually by the system administrator
</span></span></code></pre></div><p>此处显示，也就是我们的nfs-storageclass的设置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>provisioner: fuseim.pri/ifs
</span></span></code></pre></div><p>但在我们的nfs-development中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">env</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">PROVISIONER_NAME</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">value</span>: <span style="color:#ae81ff">k8s-sigs.io/nfs-subdir-external-provisioner</span>
</span></span></code></pre></div><p>所以需要修改nfs-storageclass</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">storage.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">StorageClass</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">managed-nfs-storage</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">provisioner</span>: <span style="color:#ae81ff">k8s-sigs.io/nfs-subdir-external-provisioner   </span> <span style="color:#75715e"># ← must match PROVISIONER_NAME</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">parameters</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">server</span>: <span style="color:#e6db74">&#34;192.168.79.143&#34;</span>           <span style="color:#75715e"># your NFS server</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">share</span>:  <span style="color:#e6db74">&#34;/nfs/data/nfs-share&#34;</span>      <span style="color:#75715e"># the same NFS_PATH you gave the pod</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">archiveOnDelete</span>: <span style="color:#e6db74">&#34;false&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">reclaimPolicy</span>: <span style="color:#ae81ff">Delete</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">volumeBindingMode</span>: <span style="color:#ae81ff">Immediate</span>
</span></span></code></pre></div><p>这时候删除data-nacos-0</p>
<h4 id="kubectl-delete-pvc-data-nacos-0-会卡住">kubectl delete pvc data-nacos-0 会卡住<a hidden class="anchor" aria-hidden="true" href="#kubectl-delete-pvc-data-nacos-0-会卡住">#</a></h4>
<p>先看看是否有阻碍它的finalizers</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pvc data-nacos-0 -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{.metadata.finalizers}&#39;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># e.g. [&#34;kubernetes.io/pvc-protection&#34;]</span>
</span></span></code></pre></div><p>然后清除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch pvc data-nacos-0 <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -p <span style="color:#e6db74">&#39;{&#34;metadata&#34;:{&#34;finalizers&#34;:[]}}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --type<span style="color:#f92672">=</span>merge
</span></span></code></pre></div><p>然后删除其绑定的 pv</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pv
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>kubectl delete pv &lt;pv-name&gt;
</span></span></code></pre></div><p>pv大概率也会卡住，所以也要清除</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch pv mysql-data-pv <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -p <span style="color:#e6db74">&#39;{&#34;metadata&#34;:{&#34;finalizers&#34;:[]}}&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --type<span style="color:#f92672">=</span>merge
</span></span></code></pre></div><h4 id="删除-pvc-和-pv-后nacos-0-还没有重新创建">删除 pvc 和 pv 后，nacos-0 还没有重新创建<a hidden class="anchor" aria-hidden="true" href="#删除-pvc-和-pv-后nacos-0-还没有重新创建">#</a></h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get sts nacos
</span></span></code></pre></div><p>如果看到 nacos 仍然存在，说明控制器还在，只是还没机会重建 Pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl delete pod nacos-0
</span></span></code></pre></div><p>删除掉旧 pod</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get pods -l app<span style="color:#f92672">=</span>nacos
</span></span></code></pre></div><h3 id="安装nacos镜像无法访问">安装nacos镜像无法访问<a hidden class="anchor" aria-hidden="true" href="#安装nacos镜像无法访问">#</a></h3>
<p>使用这个</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker pull nacos-registry.cn-hangzhou.cr.aliyuncs.com/nacos/nacos-server:v<span style="color:#e6db74">${</span>nacos.version<span style="color:#e6db74">}</span>
</span></span></code></pre></div><h3 id="安装ingress-controller">安装ingress-controller<a hidden class="anchor" aria-hidden="true" href="#安装ingress-controller">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl apply <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.8.1/deploy/static/provider/cloud/deploy.yaml
</span></span></code></pre></div><p>nacos-ingress.yaml</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">apiVersion</span>: <span style="color:#ae81ff">networking.k8s.io/v1</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">kind</span>: <span style="color:#ae81ff">Ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">metadata</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nacos-ingress</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nacos-web.nacos-demo.com</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>          - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/nacos</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nacos-headless</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>                  <span style="color:#f92672">name</span>: <span style="color:#ae81ff">server</span>
</span></span></code></pre></div><p>检查服务</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get svc -n ingress-nginx
</span></span></code></pre></div><p>输出，说明绑定在 32530</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style="color:#f92672">(</span>S<span style="color:#f92672">)</span>                      AGE
</span></span><span style="display:flex;"><span>ingress-nginx-controller             NodePort    10.108.58.154   &lt;none&gt;        80:32530/TCP,443:31811/TCP   11h
</span></span><span style="display:flex;"><span>ingress-nginx-controller-admission   ClusterIP   10.96.204.241   &lt;none&gt;        443/TCP                      11h
</span></span></code></pre></div><h3 id="ingress的nodeport访问不到">Ingress的NodePort访问不到<a hidden class="anchor" aria-hidden="true" href="#ingress的nodeport访问不到">#</a></h3>
<p>在 DNS 中添加解析后，还是无法访问</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># root @ sc-master in ~ [13:01:37] </span>
</span></span><span style="display:flex;"><span>$ sudo vi /etc/hosts
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root @ sc-master in ~ [13:33:23] </span>
</span></span><span style="display:flex;"><span>$ ping nacos-web.nacos-demo.com
</span></span><span style="display:flex;"><span>PING nacos-web.nacos-demo.com <span style="color:#f92672">(</span>192.168.79.144<span style="color:#f92672">)</span> 56<span style="color:#f92672">(</span>84<span style="color:#f92672">)</span> bytes of data.
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from sc-node1 <span style="color:#f92672">(</span>192.168.79.144<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>1.41 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from sc-node1 <span style="color:#f92672">(</span>192.168.79.144<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.308 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from sc-node1 <span style="color:#f92672">(</span>192.168.79.144<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.300 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from sc-node1 <span style="color:#f92672">(</span>192.168.79.144<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">4</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.401 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from sc-node1 <span style="color:#f92672">(</span>192.168.79.144<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.333 ms
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">64</span> bytes from sc-node1 <span style="color:#f92672">(</span>192.168.79.144<span style="color:#f92672">)</span>: icmp_seq<span style="color:#f92672">=</span><span style="color:#ae81ff">6</span> ttl<span style="color:#f92672">=</span><span style="color:#ae81ff">64</span> time<span style="color:#f92672">=</span>0.279 ms
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>--- nacos-web.nacos-demo.com ping statistics ---
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">6</span> packets transmitted, <span style="color:#ae81ff">6</span> received, 0% packet loss, time 5078ms
</span></span><span style="display:flex;"><span>rtt min/avg/max/mdev <span style="color:#f92672">=</span> 0.279/0.505/1.409/0.406 ms
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root @ sc-master in ~ [13:33:46] </span>
</span></span><span style="display:flex;"><span>$ nc nacos-web.nacos-demo.com <span style="color:#ae81ff">32530</span>
</span></span><span style="display:flex;"><span>^C
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># root @ sc-master in ~ [13:37:14] C:130</span>
</span></span><span style="display:flex;"><span>$ kubectl get ingress nacos-ingress -n default
</span></span><span style="display:flex;"><span>NAME            CLASS    HOSTS                      ADDRESS   PORTS   AGE
</span></span><span style="display:flex;"><span>nacos-ingress   &lt;none&gt;   nacos-web.nacos-demo.com             <span style="color:#ae81ff">80</span>      12h
</span></span></code></pre></div><p>可以看到 Class 是空的，查看日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl logs -n ingress-nginx -l app.kubernetes.io/name<span style="color:#f92672">=</span>ingress-nginx --tail <span style="color:#ae81ff">20</span> -f
</span></span><span style="display:flex;"><span><span style="color:#75715e"># log 中包含</span>
</span></span><span style="display:flex;"><span>W0501 17:18:40.042396       <span style="color:#ae81ff">6</span> controller.go:328<span style="color:#f92672">]</span> ignoring ingress default/nacos-ingress in default based on annotation : ingress does not contain a valid IngressClass
</span></span></code></pre></div><p>所以要给 Ingress <strong>指定 IngressClass</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ingressClassName</span>: <span style="color:#ae81ff">nginx</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">rules</span>:
</span></span><span style="display:flex;"><span>  - <span style="color:#f92672">host</span>: <span style="color:#ae81ff">nacos-web.nacos-demo.com</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">http</span>:
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">paths</span>:
</span></span><span style="display:flex;"><span>      - <span style="color:#f92672">path</span>: <span style="color:#ae81ff">/nacos</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">pathType</span>: <span style="color:#ae81ff">Prefix</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">backend</span>:
</span></span><span style="display:flex;"><span>          <span style="color:#f92672">service</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">name</span>: <span style="color:#ae81ff">nacos-headless</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">port</span>:
</span></span><span style="display:flex;"><span>              <span style="color:#f92672">name</span>: <span style="color:#ae81ff">server</span>
</span></span></code></pre></div><p>然后 apply，可以看到</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>I0502 06:48:38.590512 … “creating ingress” ingress<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;default/nacos-ingress&#34;</span> ingressclass<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;nginx&#34;</span>
</span></span><span style="display:flex;"><span>I0502 06:48:38.645059 … “Backend successfully reloaded”
</span></span><span style="display:flex;"><span>I0502 06:49:02.167770 … “updating Ingress status” … newValue<span style="color:#f92672">=[{</span><span style="color:#e6db74">&#34;ip&#34;</span>:<span style="color:#e6db74">&#34;10.108.58.154&#34;</span><span style="color:#f92672">}]</span>
</span></span></code></pre></div><p>再验证</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get ingress nacos-ingress -n default
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>NAME            CLASS   HOSTS                          ADDRESS         PORTS   AGE
</span></span><span style="display:flex;"><span>nacos-ingress   nginx   nacos-web.nacos-demo.com       10.108.58.154   <span style="color:#ae81ff">80</span>      10m
</span></span></code></pre></div><p>集群内部HTTP 请求可以得到回复</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ curl -H <span style="color:#e6db74">&#34;Host: nacos-web.nacos-demo.com&#34;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>     http://10.108.58.154/nacos/index.html -v
</span></span><span style="display:flex;"><span>*   Trying 10.108.58.154:80...
</span></span><span style="display:flex;"><span>* TCP_NODELAY set
</span></span><span style="display:flex;"><span>* Connected to 10.108.58.154 <span style="color:#f92672">(</span>10.108.58.154<span style="color:#f92672">)</span> port <span style="color:#ae81ff">80</span> <span style="color:#f92672">(</span><span style="color:#75715e">#0)</span>
</span></span><span style="display:flex;"><span>&gt; GET /nacos/index.html HTTP/1.1
</span></span><span style="display:flex;"><span>&gt; Host: nacos-web.nacos-demo.com
</span></span><span style="display:flex;"><span>&gt; User-Agent: curl/7.68.0
</span></span><span style="display:flex;"><span>&gt; Accept: */*
</span></span><span style="display:flex;"><span>&gt; 
</span></span><span style="display:flex;"><span>* Mark bundle as not supporting multiuse
</span></span><span style="display:flex;"><span>&lt; HTTP/1.1 <span style="color:#ae81ff">200</span> 
</span></span></code></pre></div><h4 id="集群外部还是请求不到32530端口">集群外部还是请求不到32530端口<a hidden class="anchor" aria-hidden="true" href="#集群外部还是请求不到32530端口">#</a></h4>
<p>这是因为我们 DNS 设置为</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>vim /etc/hosts
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>192.168.79.144   nacos-web.nacos-demo.com
</span></span></code></pre></div><p>但是官方的 nginx-ingress.yaml中</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">spec</span>:
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">type</span>: <span style="color:#ae81ff">NodePort</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">externalTrafficPolicy</span>: <span style="color:#ae81ff">Local</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">ports</span>:
</span></span><span style="display:flex;"><span>    - <span style="color:#f92672">name</span>: <span style="color:#ae81ff">http</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">port</span>: <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">nodePort</span>: <span style="color:#ae81ff">32530</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ae81ff">…</span>
</span></span></code></pre></div><p>我们验证一下是不是这样配置</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl get svc ingress-nginx-controller -n ingress-nginx -o yaml | grep externalTrafficPolicy
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 如果显示</span>
</span></span><span style="display:flex;"><span>externalTrafficPolicy: Local
</span></span></code></pre></div><p>就说明只有本地一个 IP 能访问，而不是 VPC 中的每个 Pod 都能访问。我们必须修改 DNS</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>192.168.79.145   nacos-web.nacos-demo.com
</span></span></code></pre></div><p>或者我们修改官方 yaml 的策略，这样任意 Node 上 NodePort 都能生效</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl patch svc ingress-nginx-controller -n ingress-nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -p <span style="color:#e6db74">&#39;{&#34;spec&#34;:{&#34;externalTrafficPolicy&#34;:&#34;Cluster&#34;}}&#39;</span>
</span></span></code></pre></div><h3 id="helm-安装jenkins">Helm 安装Jenkins<a hidden class="anchor" aria-hidden="true" href="#helm-安装jenkins">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ helm repo add jenkinsci https://charts.jenkins.io
</span></span><span style="display:flex;"><span>helm repo update
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>helm install jenkins jenkinsci/jenkins <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace cicd --create-namespace <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.serviceType<span style="color:#f92672">=</span>ClusterIP <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.ingress.enabled<span style="color:#f92672">=</span>true <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.ingress.hostName<span style="color:#f92672">=</span>jenkins.example.com <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set persistence.size<span style="color:#f92672">=</span>10Gi
</span></span><span style="display:flex;"><span>  --set persistence.storageClass<span style="color:#f92672">=</span>managed-nfs-storage
</span></span><span style="display:flex;"><span>  --set <span style="color:#e6db74">&#39;controller.env[0].name=TZ&#39;</span> <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set <span style="color:#e6db74">&#39;controller.env[0].value=Asia/Shanghai&#39;</span>
</span></span><span style="display:flex;"><span>  --set controller.ingress.ingressClassName<span style="color:#f92672">=</span>nginx <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set controller.ingress.annotations.<span style="color:#e6db74">&#34;kubernetes\.io/ingress\.class&#34;</span><span style="color:#f92672">=</span>nginx
</span></span></code></pre></div><p>查看初始密码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl exec -n cicd -it jenkins-0 -c jenkins -- cat /run/secrets/additional/chart-admin-password <span style="color:#f92672">&amp;&amp;</span> echo
</span></span></code></pre></div><h3 id="error-unknown-command-portforward-for-kubectl">error: unknown command &ldquo;port‑forward&rdquo; for &ldquo;kubectl&rdquo;<a hidden class="anchor" aria-hidden="true" href="#error-unknown-command-portforward-for-kubectl">#</a></h3>
<p>复制下面这个,-是 ASCII 字符</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>kubectl port-forward -n cicd svc/jenkins 8080:8080
</span></span></code></pre></div><h3 id="jenkins登录后报错">Jenkins登录后报错<a hidden class="anchor" aria-hidden="true" href="#jenkins登录后报错">#</a></h3>
<p>我们查看日志</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl logs -n cicd jenkins-0 -c jenkins <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  | grep -C5 &lt;此处填写logging ID&gt;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 看到以下内容</span>
</span></span><span style="display:flex;"><span>java.nio.file.NoSuchFileException: /var/jenkins_home/secrets/org.springframework.security.web.authentication.rememberme.TokenBasedRememberMeServices.mac
</span></span><span style="display:flex;"><span>        at java.base/sun.nio.fs.UnixException.translateToIOException<span style="color:#f92672">(</span>Unknown Source<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at java.base/sun.nio.fs.UnixException.rethrowAsIOException<span style="color:#f92672">(</span>Unknown Source<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at java.base/sun.nio.fs.UnixException.rethrowAsIOException<span style="color:#f92672">(</span>Unknown Source<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        at java.base/sun.nio.fs.UnixFileSystemProvider.newByteChannel<span style="color:#f92672">(</span>Unknown Source<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>文件不存在。这个错误是由于创建文件到以下路径: $JENKINS_HOME/secrets/…mac.
但是在我们的步骤中，我们使用 nfs-subdir-external-provisioner，正常来说是自动创建了 pvc</p>
<p>查看 nfs-share/下，确实存在 pvc。那么就是权限问题
Jenkins 默认不用 root 用户允许，不像 nacos。所以不具有权限，而是使用UID/GID 1000:1000
所以我们可以手工 chown，但太麻烦</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>helm upgrade jenkins jenkinsci/jenkins <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --namespace cicd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --reuse-values <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --set <span style="color:#e6db74">&#39;controller.securityContext.fsGroup=1000&#39;</span>
</span></span></code></pre></div><p>设置fsGroup
这样就 ok 了</p>
<h3 id="jenkins-k8s中无法配置-maven-和-jdk">Jenkins K8S中无法配置 maven 和 jdk<a hidden class="anchor" aria-hidden="true" href="#jenkins-k8s中无法配置-maven-和-jdk">#</a></h3>
<p>原因很简单。如果我们直接在全局 tool 中配置环境变量，是行不通的。因为实际上他对应的是Jenkins所在机器，而这个机器是k8s的一个 pod。我们把maven和jdk安装进去是十分费力的。</p>
<p>而且如果采用自动安装的方式，我遇到了JDK有一个脚本只符合bash的重定位语法，而ubuntu默认是dash。这个也很难解决</p>
<p>最后采取了配置静态节点的方法，不使用k8s插件了。配置到一台节点上进行构建</p>
<h3 id="ubuntu虚拟机创建-20g-但只有-10g">Ubuntu虚拟机创建 20G 但只有 10G<a hidden class="anchor" aria-hidden="true" href="#ubuntu虚拟机创建-20g-但只有-10g">#</a></h3>
<p>需要进行 LVM 扩容</p>
<h3 id="jenkins构建后节点磁盘空间问题">Jenkins构建后节点磁盘空间问题<a hidden class="anchor" aria-hidden="true" href="#jenkins构建后节点磁盘空间问题">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>du -sh * | sort -h   <span style="color:#75715e"># 查看各文件夹大小排序</span>
</span></span></code></pre></div><p>最后发现是 docker 里面镜像太多使用了很多空间。containerd 占用也多，不过我没清</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd /var/lib/docker
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 删除所有未运行容器、悬空镜像、网络、构建缓存、未挂载卷</span>
</span></span><span style="display:flex;"><span>docker system prune -a --volumes --force
</span></span></code></pre></div><p>然后在 Jenkinsfile 中添加</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-groovy" data-lang="groovy"><span style="display:flex;"><span>post <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    always <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        sh <span style="color:#e6db74">&#39;docker system prune -af --volumes&#39;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><h3 id="dockerhub-限速问题">DockerHub 限速问题<a hidden class="anchor" aria-hidden="true" href="#dockerhub-限速问题">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># 1. 删除旧的 secret</span>
</span></span><span style="display:flex;"><span>kubectl delete secret dockerhub-auth -n cicd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2. 重新创建（把下面的 &lt;用户名&gt;、&lt;PAT&gt;、&lt;email&gt; 换成正确的）</span>
</span></span><span style="display:flex;"><span>kubectl create secret docker-registry dockerhub-auth <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-server<span style="color:#f92672">=</span>https://index.docker.io/v1/ <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-username<span style="color:#f92672">=</span>&lt;DockerID&gt; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-password<span style="color:#f92672">=</span>&lt;新的PAT_or_密码&gt; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  --docker-email<span style="color:#f92672">=</span>&lt;邮箱地址&gt; <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -n cicd
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3. 应用到 Jenkins Chart 默认 SA 叫 &#34;jenkins&#34;（你也可以 helm get values 看真实名字）</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 这边我用helm部署自带了sa</span>
</span></span><span style="display:flex;"><span>kubectl patch serviceaccount jenkins -n cicd <span style="color:#ae81ff">\
</span></span></span><span style="display:flex;"><span><span style="color:#ae81ff"></span>  -p<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;{&#34;imagePullSecrets&#34;:[{&#34;name&#34;:&#34;dockerhub-auth&#34;}]}&#39;</span>
</span></span></code></pre></div><p>不过最好还是推到阿里云私有仓库，懒得搞了，实验先这样</p>
<p>不过在这个过程中还发现可能是我的代理服务器问题。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>$ kubectl describe pod jenkins -n cicd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span>failed to fetch anonymous token: Get <span style="color:#e6db74">&#34;https://auth.docker.io/token?scope=repository%3Ajenkins%2Fjenkins%3Apull&amp;service=registry.docker.io&#34;</span>: EOF
</span></span></code></pre></div><p>中间换过一次全局代理，可能是clash 有 bug。可以重启一下</p>
<h3 id="springboot-bootstrap问题">Springboot bootstrap问题<a hidden class="anchor" aria-hidden="true" href="#springboot-bootstrap问题">#</a></h3>
<p>需要引入 maven 依赖，才能使用</p>
<h3 id="dashboard-token">dashboard token<a hidden class="anchor" aria-hidden="true" href="#dashboard-token">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo kubectl -n kubernetes-dashboard create token dashboard-admin --duration<span style="color:#f92672">=</span>24h
</span></span></code></pre></div><h3 id="k8s驱逐问题">k8s驱逐问题<a hidden class="anchor" aria-hidden="true" href="#k8s驱逐问题">#</a></h3>
<p>在原有的<code>/var/lib/kubelet/config.yaml</code>中添加一条。注意是顶级的，不需要 tab</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-yaml" data-lang="yaml"><span style="display:flex;"><span><span style="color:#f92672">evictionHard</span>:
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">imagefs.available</span>: <span style="color:#e6db74">&#34;15%&#34;</span> <span style="color:#75715e"># 镜像文件系统可用空间低于15%时触发驱逐 (如果您的镜像存储和节点根文件系统是分开的)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">imagefs.inodesFree</span>: <span style="color:#e6db74">&#34;5%&#34;</span> <span style="color:#75715e"># 镜像文件系统可用inode低于5%时触发驱逐</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">memory.available</span>: <span style="color:#e6db74">&#34;100Mi&#34;</span> <span style="color:#75715e"># 节点可用内存低于100Mi时触发驱逐</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">nodefs.available</span>: <span style="color:#e6db74">&#34;10%&#34;</span> <span style="color:#75715e"># 节点根文件系统可用空间低于10%时触发驱逐 (这是您主要关注的)</span>
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">nodefs.inodesFree</span>: <span style="color:#e6db74">&#34;5%&#34;</span> <span style="color:#75715e"># 节点根文件系统可用inode低于5%时触发驱逐</span>
</span></span></code></pre></div><h3 id="sentinel识别不到服务">Sentinel识别不到服务<a hidden class="anchor" aria-hidden="true" href="#sentinel识别不到服务">#</a></h3>
<p>需要增加一个暴露的port用于与sentinel连接</p>
<h3 id="helm部署rabbitmq">helm部署RabbitMQ<a hidden class="anchor" aria-hidden="true" href="#helm部署rabbitmq">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Username      : user&#34;</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;Password      : </span><span style="color:#66d9ef">$(</span>kubectl get secret --namespace default rabbitmq -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.rabbitmq-password}&#34;</span> | base64 -d<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span><span style="display:flex;"><span>    echo <span style="color:#e6db74">&#34;ErLang Cookie : </span><span style="color:#66d9ef">$(</span>kubectl get secret --namespace default rabbitmq -o jsonpath<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;{.data.rabbitmq-erlang-cookie}&#34;</span> | base64 -d<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span>
</span></span></code></pre></div>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/zh/tags/problem/">Problem</a></li>
      <li><a href="http://localhost:1313/zh/tags/ubuntu/">Ubuntu</a></li>
      <li><a href="http://localhost:1313/zh/tags/kubernetes/">Kubernetes</a></li>
      <li><a href="http://localhost:1313/zh/tags/cicd/">Cicd</a></li>
      <li><a href="http://localhost:1313/zh/tags/nacos/">Nacos</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/zh/posts/%E5%9C%A8%E4%B8%80%E4%B8%AA-git-%E4%BB%93%E5%BA%93%E4%B8%AD%E8%81%9A%E5%90%88%E4%B8%A4%E4%B8%AA%E9%A1%B9%E7%9B%AE/">
    <span class="title">« 上一页</span>
    <br>
    <span>在一个 Git 仓库中聚合两个项目</span>
  </a>
  <a class="next" href="http://localhost:1313/zh/posts/tailwind-svg-%E9%A2%9C%E8%89%B2%E9%97%AE%E9%A2%98/">
    <span class="title">下一页 »</span>
    <br>
    <span>SVG 颜色问题</span>
  </a>
</nav>

  </footer><script src="https://utteranc.es/client.js"
        repo="Ch1ldKing/myblog"
        issue-term="pathname"
        label="💬comment💬"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2025 <a href="http://localhost:1313/zh/">Dorianyang 的妙妙文档</a></span> · 

    <span>
        <a href="https://icp.gov.moe/?keyword=20256818" target="_blank">萌ICP备20256818号</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '复制';

        function copyingDone() {
            copybutton.innerHTML = '已复制！';
            setTimeout(() => {
                copybutton.innerHTML = '复制';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
